/* ===================== CONFIG ===================== */
/** Optional: set this later if you deploy a Vercel API
 *  e.g. const API_BASE_URL = "https://parcel-api-xyz.vercel.app";
 */
const API_BASE_URL = "";

/* ===================== STATE ====================== */
let map, drawManager;
let lotPolygon = null;
const turfPolygons = [];

/* ===================== INIT ======================= */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 39.8283, lng: -98.5795 },
    zoom: 4,
    mapTypeId: "roadmap",
    tilt: 0,
    heading: 0,
  });

  drawManager = new google.maps.drawing.DrawingManager({
    drawingControl: false,
    polygonOptions: { fillColor: "#22c55e55", strokeColor: "#16a34a", strokeWeight: 2 },
  });
  drawManager.setMap(map);

  setupAutocomplete(); // uses #address
  bindUI();            // wires your buttons by ID
  forceTopDown();
  lockTopDown();
}
window.initMap = initMap; // REQUIRED for the Google callback

/* ================= AUTOCOMPLETE =================== */
function setupAutocomplete() {
  const input = document.getElementById("address");
  if (!input) return;

  // Places Autocomplete
  const ac = new google.maps.places.Autocomplete(input, { fields: ["geometry"] });
  ac.addListener("place_changed", () => {
    const place = ac.getPlace();
    if (place && place.geometry && place.geometry.location) {
      map.setCenter(place.geometry.location);
      map.setZoom(18);
      forceTopDown();
      setCaption("Address found. You can outline the lot or start measuring turf.");
    }
  });

  // Fallback: Enter key triggers Geocoder if autocomplete didn't fire
  input.addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const q = (input.value || "").trim();
      if (q) await fallbackGeocode(q);
    }
  });
}

/* ===================== UI ========================= */
function bindUI() {
  const $ = (id) => document.getElementById(id);

  // Right panel tools (your IDs)
  $("btnOutlineLot")?.addEventListener("click", startDrawingLot);
  $("btnManualTurf")?.addEventListener("click", startDrawingTurf);

  // Measure Now button (center column)
  $("measureBtn")?.addEventListener("click", () => {
    setCaption("Click around the turf area. Double-click to finish.");
    startDrawingTurf();
  });

  // Search Again: clear shapes and form fields, keep the map
  $("btnSearchAgain")?.addEventListener("click", () => {
    resetAll();
    setCaption("Type an address and press Enter.");
    $("address")?.focus();
  });
}

/* =============== DRAWING & STYLING ================ */
function startDrawingLot() {
  drawManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
  google.maps.event.addListenerOnce(drawManager, "polygoncomplete", (poly) => {
    if (lotPolygon) lotPolygon.setMap(null);
    lotPolygon = poly;
    styleLotPolygon(lotPolygon);
    drawManager.setDrawingMode(null);
    fitToPolygon(lotPolygon);
    updateAreas();
    setCaption("Lot outlined. Now add turf polygons or click Measure Now.");
  });
}

function startDrawingTurf() {
  drawManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
  google.maps.event.addListenerOnce(drawManager, "polygoncomplete", (poly) => {
    poly.setOptions({ fillColor: "#22c55e55", strokeColor: "#16a34a", strokeWeight: 2 });
    turfPolygons.push(poly);
    drawManager.setDrawingMode(null);
    updateAreas();
  });
}

function styleLotPolygon(poly) {
  poly.setOptions({ fillColor: "#00000000", strokeColor: "#ef4444", strokeWeight: 2 }); // red outline, no fill
}

function fitToPolygon(poly) {
  const bounds = new google.maps.LatLngBounds();
  poly.getPath().forEach((p) => bounds.extend(p));
  map.fitBounds(bounds);
  forceTopDown();
}

/* =================== AREAS ======================== */
function updateAreas() {
  const lotFt2 =
    lotPolygon ? google.maps.geometry.spherical.computeArea(lotPolygon.getPath()) * 10.7639 : 0;

  const turfFt2 = turfPolygons.reduce((sum, p) => {
    const m2 = google.maps.geometry.spherical.computeArea(p.getPath());
    return sum + m2 * 10.7639;
  }, 0);

  const setNum = (id, n) => {
    const el = document.getElementById(id);
    if (el) el.value = Math.round(n);
  };
  setNum("lotSqft", lotFt2);
  setNum("turfSqft", turfFt2);
}

/* ================= CAMERA CONTROL ================= */
function forceTopDown() {
  if (!map) return;
  map.setMapTypeId("roadmap"); // avoids 45Â° imagery
  map.setHeading(0);
  map.setTilt(0);
}
function lockTopDown() {
  map.addListener("tilt_changed", () => map.getTilt() !== 0 && map.setTilt(0));
  map.addListener("heading_changed", () => map.getHeading() !== 0 && map.setHeading(0));
}

/* ================== GEOCODER Fallback ============= */
async function fallbackGeocode(query) {
  const geocoder = new google.maps.Geocoder();
  return new Promise((resolve) => {
    geocoder.geocode({ address: query }, (results, status) => {
      if (status === "OK" && results[0]) {
        const loc = results[0].geometry.location;
        map.setCenter(loc);
        map.setZoom(18);
        forceTopDown();
        setCaption("Address found. Outline the lot or start measuring turf.");
      }
      resolve();
    });
  });
}

/* ================== UTILITIES ===================== */
function setCaption(text) {
  const el = document.getElementById("mapCaption");
  if (el) el.textContent = text;
}

function resetAll() {
  if (lotPolygon) { lotPolygon.setMap(null); lotPolygon = null; }
  while (turfPolygons.length) turfPolygons.pop().setMap(null);

  const ids = ["lotSqft", "turfSqft", "firstName", "lastName", "phone", "email"];
  ids.forEach((id) => { const el = document.getElementById(id); if (el) el.value = ""; });
}
